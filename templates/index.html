<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ config.app_title }} - Feedback App</title>
  <link rel="stylesheet" href="static/style.css">
</head>
<body>
  <div class="container">
    <header>
      <img src="{{ config.logo_path }}" alt="App Logo" class="header-logo">
      <h2>{{ config.app_title }}</h2>
      <p>{{ config.app_description }}</p>
    </header>

    <div class="main-layout">
      <nav class="sidebar">
        <ul>
          <li><a href="#" id="show-existing">Bestehende Fragen</a></li>
          <li><a href="#" id="show-new">Neue Frage</a></li>
          <li><a href="#" id="show-explanation">Erkl√§rung</a></li>
        </ul>
      </nav>

      <div class="content-area">
        <section id="existing-feedback-section" class="content-section active">
          <h2>Bestehende Fragen</h2>
          {% if feedbacks %}
            <ul class="feedback-items">
              {% for fb in feedbacks %}
                <li class="feedback-item">
                  <div class="feedback-votes">
                    <a href="#" class="vote-button upvote" data-fid="{{ fb['id'] }}" data-direction="up">‚ñ≤</a>
                    <span class="vote-count">{{ fb['votes'] }}</span>
                    <a href="#" class="vote-button downvote" data-fid="{{ fb['id'] }}" data-direction="down">‚ñº</a>
                  </div>
                  <div class="feedback-content">
                    <div class="question-wrapper">
                        <h3 class="feedback-question">{{ fb['question'] }}</h3>
                    </div>

                    <div class="description-wrapper">
                        <span class="description-toggle-arrow" data-target-id="desc-{{ fb['id'] }}">‚ñ∂</span>
                        <p class="feedback-description-short">{{ fb['description'] }}</p>
                        <p class="feedback-description-full">{{ fb['description'] }}</p>
                    </div>

                    <p class="feedback-meta">
                      Eingereicht von: <strong>{{ fb['name'] }}</strong>
                      {% if fb['timestamp'] %} am {{ fb['timestamp'] }}{% endif %}
                    </p>
                    <p class="all-upvoters-list">Unterst√ºtzer:innen:
                        {% if fb['upvoter_names_list'] %}
                            {{ fb['upvoter_names_list'] | join(', ') }}
                        {% else %}
                            Keiner
                        {% endif %}
                    </p>
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="no-feedback">Noch keine Fragen gestellt. Sei der Erste!</p>
          {% endif %}
        </section>

        <section id="new-question-section" class="content-section">
          <h2>Neue Frage stellen</h2>
          <form method="POST" action="{{ url_for('submit_feedback') }}" id="feedback-form">
            <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 5px;">
              <input type="text" name="name" id="user-name-input" placeholder="Dein Name" required>
              <input type="hidden" name="upvoter_id" id="upvoter-id-input">
              <span id="edit-name-icon" style="display:none; cursor:pointer;">‚úèÔ∏è</span>
              <span id="upvoter-id-display" style="display:none;"></span>
              <span id="toggle-upvoter-id-display-icon" style="cursor:pointer;">üëÅÔ∏è</span>
            </div>
            <input type="text" name="question" id="question-input" placeholder="Deine Frage/Thema" required>
            <textarea name="description" id="description-textarea" placeholder="Weitere Details zur Frage..."></textarea>
            <button type="submit" id="submit-button">Frage einreichen</button>
          </form>
        </section>

        <section id="explanation-section" class="content-section">
          <h2>Erkl√§rung zur App</h2>
          <div class="explanation-text">
            <p>Diese einfache Feedback-Anwendung erm√∂glicht es Nutzern, Fragen oder Themen einzureichen und √ºber bestehende Beitr√§ge abzustimmen. Jeder Beitrag hat eine Frage, eine optionale Beschreibung und den Namen des Einreichenden.</p>
            <p><strong>Bestehende Fragen:</strong> Hier sehen Sie alle eingereichten Fragen, sortiert nach der Anzahl der Unterst√ºtzer:innen. Sie k√∂nnen Fragen unterst√ºtzen oder downvoten. Ihre Stimme wird gez√§hlt und Ihre eindeutige ID wird im Browser gespeichert.</p>
            <p><strong>Neue Frage:</strong> Hier k√∂nnen Sie eine neue Frage oder ein neues Thema einreichen. Ihr Name wird automatisch aus Ihrem Browser-Speicher vorausgef√ºllt und ist √§nderbar. Ihre **Upvoter-ID** wird einmalig generiert und bleibt unver√§nderlich, sie dient als eindeutiger Identifier f√ºr Ihre Stimmen.</p>
            <p><strong>Unterst√ºtzen:</strong> Wenn Sie einen Beitrag unterst√ºtzen, wird Ihre eindeutige Upvoter-ID in der Liste der Unterst√ºtzer:innen dieses Beitrags gespeichert. Sie k√∂nnen einen Beitrag nur einmal unterst√ºtzen.</p>
            <p>Viel Spa√ü beim Geben und Empfangen von Feedback!</p>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    function saveUserName(name) {
      if (typeof(Storage) !== "undefined") {
        localStorage.setItem("simvote_username", name);
      }
    }

    function loadUserName() {
      if (typeof(Storage) !== "undefined") {
        return localStorage.getItem("simvote_username");
      }
      return null;
    }

    function saveUpvoterId(id) {
      if (typeof(Storage) !== "undefined") {
        localStorage.setItem("simvote_upvoterid", id);
      }
    }

    function loadUpvoterId() {
      if (typeof(Storage) !== "undefined") {
        return localStorage.getItem("simvote_upvoterid");
      }
      return null;
    }

    function generateUUID() {
        if (crypto && crypto.randomUUID) {
            return crypto.randomUUID();
        }
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function initializeUserNameAndUpvoterId() {
      const userNameInput = document.getElementById('user-name-input');
      const upvoterIdInput = document.getElementById('upvoter-id-input');
      const editNameIcon = document.getElementById('edit-name-icon');
      const upvoterIdDisplay = document.getElementById('upvoter-id-display');
      const toggleUpvoterIdDisplayIcon = document.getElementById('toggle-upvoter-id-display-icon');

      let storedUserName = loadUserName();
      let storedUpvoterId = loadUpvoterId();

      if (storedUserName) {
        userNameInput.value = storedUserName;
        userNameInput.readOnly = true;
        editNameIcon.style.display = 'inline-block';
      } else {
        userNameInput.value = '';
        userNameInput.readOnly = false;
        editNameIcon.style.display = 'none';
        userNameInput.focus();
      }

      if (!storedUpvoterId) {
        storedUpvoterId = generateUUID();
        saveUpvoterId(storedUpvoterId);
      }
      upvoterIdInput.value = storedUpvoterId;
      upvoterIdDisplay.textContent = `ID: ${storedUpvoterId}`;

      userNameInput.removeEventListener('blur', saveAndLockName);
      userNameInput.addEventListener('blur', saveAndLockName);

      editNameIcon.removeEventListener('click', enableNameEdit);
      editNameIcon.addEventListener('click', enableNameEdit);

      toggleUpvoterIdDisplayIcon.removeEventListener('click', toggleUpvoterIdDisplay);
      toggleUpvoterIdDisplayIcon.addEventListener('click', toggleUpvoterIdDisplay);
    }

    function saveAndLockName() {
        const userNameInput = document.getElementById('user-name-input');
        const editNameIcon = document.getElementById('edit-name-icon');
        if (userNameInput.value.trim() !== '') {
            saveUserName(userNameInput.value.trim());
            userNameInput.readOnly = true;
            editNameIcon.style.display = 'inline-block';
            attachVoteEventListeners();
        }
    }

    function enableNameEdit() {
        const userNameInput = document.getElementById('user-name-input');
        const editNameIcon = document.getElementById('edit-name-icon');
        userNameInput.readOnly = false;
        userNameInput.focus();
        editNameIcon.style.display = 'none';
    }

    function toggleUpvoterIdDisplay() {
        const upvoterIdDisplay = document.getElementById('upvoter-id-display');
        if (upvoterIdDisplay.style.display === 'none' || upvoterIdDisplay.style.display === '') {
            upvoterIdDisplay.style.display = 'inline-block';
        } else {
            upvoterIdDisplay.style.display = 'none';
        }
    }

    function attachVoteEventListeners() {
      document.querySelectorAll('.vote-button').forEach(button => {
        button.removeEventListener('click', handleVoteClick);
        button.addEventListener('click', handleVoteClick);
      });
    }

    function handleVoteClick(event) {
        event.preventDefault();
        const button = event.currentTarget;
        const fid = button.dataset.fid;
        const direction = button.dataset.direction;
        const userName = loadUserName();
        const upvoterId = loadUpvoterId();

        if (!userName || userName.trim() === '' || !upvoterId) {
            alert("Bitte gib zuerst deinen Namen ein und best√§tige ihn, bevor du abstimmst.");
            showSection('new-question-section');
            initializeUserNameAndUpvoterId();
            return;
        }

        const voteUrl = `/vote/${fid}/${direction}/${encodeURIComponent(upvoterId)}/${encodeURIComponent(userName)}`;
        window.location.href = voteUrl;
    }

    const sections = document.querySelectorAll('.content-section');
    const navLinks = {
      'show-existing': 'existing-feedback-section',
      'show-new': 'new-question-section',
      'show-explanation': 'explanation-section'
    };

    function showSection(id) {
      sections.forEach(section => {
        if (section.id === id) {
          section.classList.add('active');
        } else {
          section.classList.remove('active');
        }
      });
    }

    function setupDescriptionToggles() {
        document.querySelectorAll('.description-wrapper').forEach(wrapper => {
            const shortDesc = wrapper.querySelector('.feedback-description-short');
            const fullDesc = wrapper.querySelector('.feedback-description-full');
            const toggleArrow = wrapper.querySelector('.description-toggle-arrow');

            // Determine if the description is long enough to need a toggle
            // A simple check: if the full text is longer than a reasonable 'short' length
            // or if it contains newlines.
            const fullText = fullDesc.textContent.trim();
            const isTextLong = fullText.length > 50 || fullText.includes('\n'); // Adjust 50 as needed

            if (isTextLong) {
                toggleArrow.style.display = 'inline-block';
                shortDesc.style.display = 'block';
                fullDesc.style.display = 'none';
            } else {
                toggleArrow.style.display = 'none'; // Hide arrow if text is short
                shortDesc.style.display = 'block'; // Always show short text by default
                fullDesc.style.display = 'none';
            }

            toggleArrow.onclick = () => {
                if (shortDesc.style.display === 'block') {
                    shortDesc.style.display = 'none';
                    fullDesc.style.display = 'block';
                    toggleArrow.textContent = '‚ñº';
                } else {
                    shortDesc.style.display = 'block';
                    fullDesc.style.display = 'none';
                    toggleArrow.textContent = '‚ñ∂';
                }
            };
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const feedbackForm = document.getElementById('feedback-form');
        if (feedbackForm) {
            feedbackForm.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && event.target.tagName !== 'TEXTAREA') {
                    event.preventDefault();
                    document.getElementById('submit-button').click();
                }
            });
        }

        for (const [linkId, sectionId] of Object.entries(navLinks)) {
            document.getElementById(linkId).addEventListener('click', (event) => {
                event.preventDefault();
                showSection(sectionId);
                if (sectionId === 'new-question-section') {
                    initializeUserNameAndUpvoterId();
                }
                if (sectionId === 'existing-feedback-section') {
                    attachVoteEventListeners();
                    setupDescriptionToggles();
                }
            });
        }

        showSection('existing-feedback-section');
        attachVoteEventListeners();
        setupDescriptionToggles();
        initializeUserNameAndUpvoterId();
    });
  </script>
</body>
</html>